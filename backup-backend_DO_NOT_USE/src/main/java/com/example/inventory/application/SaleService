package com.example.inventory.application;

import com.example.inventory.domain.Sale;
import com.example.inventory.domain.SaleItem;
import com.example.inventory.repository.ProductVariantRepository;
import com.example.inventory.repository.SaleItemRepository;
import com.example.inventory.repository.SaleRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Service
public class SaleService {

    private final SaleRepository saleRepo;
    private final SaleItemRepository itemRepo;
    private final ProductVariantRepository variantRepo;

    public SaleService(SaleRepository saleRepo, SaleItemRepository itemRepo, ProductVariantRepository variantRepo) {
        this.saleRepo = saleRepo;
        this.itemRepo = itemRepo;
        this.variantRepo = variantRepo;
    }

    @Transactional
    public Sale createSale(Sale sale) {
        if (sale.getItems() == null || sale.getItems().isEmpty())
            throw new IllegalArgumentException("Sale items required");

        sale.setCreatedAt(LocalDateTime.now());

        BigDecimal total = BigDecimal.ZERO;

        for (SaleItem item : sale.getItems()) {
            if (item.getQty() == null || item.getQty() <= 0)
                throw new IllegalArgumentException("qty must be > 0");

            var variant = variantRepo.findById(item.getVariantId())
                    .orElseThrow(() -> new IllegalArgumentException("Variant not found: " + item.getVariantId()));

            if (variant.getQuantity() < item.getQty())
                throw new IllegalArgumentException("Insufficient stock for variant: " + variant.getSku());

            // fiyat (ilk sürüm): request'ten geliyorsa kullan, yoksa variant price
            BigDecimal unitPrice = item.getUnitPrice() != null ? item.getUnitPrice() : variant.getPrice();
            BigDecimal lineTotal = unitPrice.multiply(BigDecimal.valueOf(item.getQty()));

            item.setUnitPrice(unitPrice);
            item.setLineTotal(lineTotal);

            // stok düş
            variant.setQuantity(variant.getQuantity() - item.getQty());
            variantRepo.save(variant);

            total = total.add(lineTotal);
        }

        sale.setTotal(total);
        var saved = saleRepo.save(sale);
        itemRepo.saveAll(saved.getId(), sale.getItems());
        return saved;
    }
}
