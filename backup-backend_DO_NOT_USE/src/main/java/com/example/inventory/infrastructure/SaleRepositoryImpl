package com.example.inventory.infrastructure;

import com.example.inventory.domain.PagedResult;
import com.example.inventory.domain.Sale;
import com.example.inventory.repository.SaleRepository;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.Optional;

@Repository
public class SaleRepositoryImpl implements SaleRepository {

    private final JpaSaleRepository jpa;

    public SaleRepositoryImpl(JpaSaleRepository jpa) { this.jpa = jpa; }

    @Override
    public Sale save(Sale sale) {
        var e = JpaSaleEntity.builder()
                .id(sale.getId())
                .createdAt(sale.getCreatedAt())
                .total(sale.getTotal())
                .build();
        var saved = jpa.save(e);
        sale.setId(saved.getId());
        return sale;
    }

    @Override
    public Optional<Sale> findById(Long id) {
        return jpa.findById(id).map(e -> new Sale(e.getId(), e.getCreatedAt(), e.getTotal(), null));
    }

    @Override
    public PagedResult<Sale> findPaged(Integer page, Integer size, String sort, String dir,
                                       LocalDateTime from, LocalDateTime to) {
        Sort s = Sort.by((dir==null || dir.equalsIgnoreCase("asc"))? Sort.Direction.ASC:Sort.Direction.DESC,
                (sort==null || sort.isBlank())? "createdAt" : sort);

        Pageable pageable = PageRequest.of(Math.max(0,page==null?0:page), Math.max(1,size==null?10:size), s);
        // Basit: filtrelemeyi service tarafında yapacağız (ilk sürüm)
        var data = jpa.findAll(pageable);

        var items = data.getContent().stream()
                .map(e -> new Sale(e.getId(), e.getCreatedAt(), e.getTotal(), null))
                .toList();

        return new PagedResult<>(items, data.getTotalElements(), data.getTotalPages(), data.getNumber(), data.getSize());
    }
}
