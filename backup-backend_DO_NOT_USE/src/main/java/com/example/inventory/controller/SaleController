package com.example.inventory.controller;

import com.example.inventory.application.SaleService;
import com.example.inventory.controller.dto.*;
import com.example.inventory.domain.Sale;
import com.example.inventory.domain.SaleItem;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/sales")
public class SaleController {

    private final SaleService service;

    public SaleController(SaleService service) { this.service = service; }

    @PostMapping
    public ResponseEntity<SaleResponse> create(@RequestBody SaleRequest req) {
        var sale = new Sale();
        var items = req.items.stream()
                .map(i -> new SaleItem(null, null, i.variantId, i.qty, i.unitPrice, null))
                .collect(Collectors.toList());
        sale.setItems(items);

        var saved = service.createSale(sale);

        SaleResponse resp = new SaleResponse();
        resp.id = saved.getId();
        resp.createdAt = saved.getCreatedAt();
        resp.total = saved.getTotal();
        resp.items = items.stream().map(i -> {
            SaleItemResponse r = new SaleItemResponse();
            r.variantId = i.getVariantId();
            r.qty = i.getQty();
            r.unitPrice = i.getUnitPrice();
            r.lineTotal = i.getLineTotal();
            return r;
        }).toList();

        return ResponseEntity.ok(resp);
    }
}
